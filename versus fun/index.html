<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versus Arena - Neon Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #bc13fe;
            --bg-dark: #050505;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            overflow: hidden; /* Mencegah scroll saat animasi */
        }

        /* --- ANIMATED BACKGROUND --- */
        .background-anim {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, #0f0c29, #302b63, #24243e);
            background-size: 400% 400%;
            z-index: -2;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Partikel Melayang */
        .particles span {
            position: absolute;
            bottom: -50px;
            background: transparent;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-pink);
            animation: animateParticles 10s linear infinite;
            z-index: -1;
        }
        .particles span:nth-child(1) { left: 10%; width: 20px; height: 20px; animation-duration: 7s; }
        .particles span:nth-child(2) { left: 30%; width: 40px; height: 40px; animation-duration: 10s; animation-delay: 2s; }
        .particles span:nth-child(3) { left: 70%; width: 15px; height: 15px; animation-duration: 5s; animation-delay: 1s; }
        .particles span:nth-child(4) { left: 90%; width: 30px; height: 30px; animation-duration: 9s; animation-delay: 0s; }

        @keyframes animateParticles {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* --- UI COMPONENTS --- */
        .screen { display: none; width: 100%; max-width: 480px; padding: 20px; z-index: 10; }
        .active { display: block; animation: zoomIn 0.4s ease-out; }

        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        h1 {
            font-size: 3rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue);
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        input {
            width: 80%;
            padding: 15px;
            border-radius: 50px;
            border: 2px solid var(--neon-blue);
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 1.2rem;
            text-align: center;
            outline: none;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        button {
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink));
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(188, 19, 254, 0.5);
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--neon-pink);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .game-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.3s;
        }
        .game-card:hover { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.1); }
        .game-icon { font-size: 2.5rem; display: block; margin-bottom: 5px; }

        /* Game Specific */
        .ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 220px; margin: 20px auto; }
        .ttt-cell { height: 70px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; cursor: pointer; border-radius: 5px; }
        
        #loading-msg { color: var(--neon-blue); margin-top: 10px; font-style: italic; display: none; }
    </style>
</head>
<body>

    <div class="background-anim"></div>
    <div class="particles">
        <span></span><span></span><span></span><span></span>
    </div>

    <div id="screen-landing" class="screen active">
        <div class="glass-panel">
            <h1>VERSUS<br><span style="color:var(--neon-blue)">ARENA</span></h1>
            <p style="letter-spacing: 1px;">Realtime Multiplayer Battle</p>
            <br>
            <button onclick="goToLobby()">PLAY GAME</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="glass-panel">
            <h2 style="color:var(--neon-blue)">JOIN ROOM</h2>
            <p>Masukkan Kode Room (Bebas)</p>
            <input type="text" id="room-code" placeholder="Cth: 777" maxlength="6">
            <button id="btn-join" onclick="joinRoom()">CONNECT</button>
            <button onclick="backTo('landing')" style="background: transparent; border: 1px solid white; box-shadow: none; margin-top: 15px;">BACK</button>
            <p id="loading-msg">Menghubungkan ke Server...</p>
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div id="status-bar" style="background: rgba(0,0,0,0.5); padding: 5px; border-radius: 10px; margin-bottom: 10px; font-size: 0.9rem;">Waiting...</div>
        <h2 style="margin: 0;">PILIH GAME</h2>
        <div class="game-grid">
            <div class="game-card" onclick="selectGame('tictactoe')"><span class="game-icon">‚ùå‚≠ï</span>TicTacToe</div>
            <div class="game-card" onclick="selectGame('rps')"><span class="game-icon">‚úÇÔ∏èü™®</span>Suit</div>
            <div class="game-card" onclick="selectGame('math')"><span class="game-icon">üî¢</span>Math</div>
            <div class="game-card" onclick="selectGame('dice')"><span class="game-icon">üé≤</span>Dice</div>
            <div class="game-card" onclick="selectGame('word')"><span class="game-icon">‚å®Ô∏è</span>Typing</div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <button onclick="backToMenu()" style="padding: 5px 15px; width: auto; font-size: 0.8rem; background: #333; box-shadow: none;">EXIT</button>
        <h2 id="game-title" style="color:var(--neon-pink); margin-top:10px;">Game</h2>
        <div id="game-container" class="glass-panel" style="min-height: 250px; display:flex; flex-direction:column; justify-content:center; align-items:center;"></div>
        <h3 id="game-result" style="color: yellow; text-shadow: 0 0 5px orange;"></h3>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // PASTIKAN KEY INI BENAR (Cek spasi di awal/akhir saat copas)
        const SUPABASE_URL = 'https://tbusnooxowzqozuvczbo.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidXNub294b3d6cW96dXZjemJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MzA2NDQsImV4cCI6MjA4MDMwNjY0NH0.O_zyLs_gwD2EhdiqakEY8FVzcTcK22OI-a2UmEdE-NY';

        // Initialize Supabase
        let supabase;
        try {
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("Supabase Client Initialized");
        } catch (err) {
            alert("Gagal inisialisasi Supabase. Cek URL/Key di kodingan.");
            console.error(err);
        }

        // --- GLOBAL VARIABLES ---
        let myId = Math.random().toString(36).substr(2, 6).toUpperCase();
        let channel = null;
        let isHost = false; 

        // --- NAVIGATION ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${id}`).classList.add('active');
        }
        function backTo(screen) { showScreen(screen); }
        function goToLobby() { showScreen('lobby'); }
        
        function backToMenu() {
            if(channel) channel.send({ type: 'broadcast', event: 'force_menu', payload: {} });
            resetGameUI();
            showScreen('menu');
        }

        function resetGameUI() {
            document.getElementById('game-container').innerHTML = '';
            document.getElementById('game-result').innerText = '';
        }

        // --- 2. CORE CONNECTION LOGIC (FIXED) ---
        async function joinRoom() {
            const code = document.getElementById('room-code').value.trim();
            if (!code) return alert("Isi kode ruangan dulu!");

            const btn = document.getElementById('btn-join');
            const msg = document.getElementById('loading-msg');
            
            // UI Loading State
            btn.disabled = true;
            btn.innerText = "CONNECTING...";
            msg.style.display = 'block';

            // Bersihkan channel lama jika ada
            if (channel) await supabase.removeChannel(channel);

            console.log(`Connecting to room: room_${code}`);

            // Buat Channel Baru
            channel = supabase.channel(`room_${code}`, {
                config: { presence: { key: myId } }
            });

            // Listener Event
            channel
                .on('presence', { event: 'sync' }, () => {
                    const state = channel.presenceState();
                    const users = Object.keys(state);
                    console.log("Presence Sync:", users);
                    document.getElementById('status-bar').innerText = `Room: ${code} | Players: ${users.length}/2`;
                    
                    // Logic Host sederhana: User dengan ID string terkecil jadi host (konsisten di kedua device)
                    users.sort();
                    isHost = (users[0] === myId); 
                })
                .on('broadcast', { event: 'select_game' }, ({ payload }) => loadGame(payload.game))
                .on('broadcast', { event: 'game_move' }, ({ payload }) => handleMove(payload))
                .on('broadcast', { event: 'force_menu' }, () => { resetGameUI(); showScreen('menu'); });

            // Subscribe dengan Callback Status
            channel.subscribe(async (status, err) => {
                console.log("Subscription Status:", status);
                
                if (status === 'SUBSCRIBED') {
                    // BERHASIL! Baru kita pindah layar
                    await channel.track({ online_at: new Date().toISOString() });
                    btn.disabled = false;
                    btn.innerText = "CONNECT";
                    msg.style.display = 'none';
                    showScreen('menu');
                } else {
                    // GAGAL
                    console.error("Supabase Error:", err);
                    btn.disabled = false;
                    btn.innerText = "RETRY";
                    msg.innerText = "Gagal Konek. Cek Console & API Key.";
                    alert("Gagal terhubung ke server. Cek API Key & URL Supabase Anda.");
                }
            });
        }

        // --- 3. GAME MANAGER ---
        let currGame = '';

        function selectGame(game) {
            channel.send({ type: 'broadcast', event: 'select_game', payload: { game: game } });
            loadGame(game);
        }

        function loadGame(game) {
            currGame = game;
            resetGameUI();
            showScreen('game');
            const title = document.getElementById('game-title');
            const container = document.getElementById('game-container');

            if (game === 'tictactoe') initTTT(container, title);
            else if (game === 'rps') initRPS(container, title);
            else if (game === 'dice') initDice(container, title);
            else if (game === 'math') initMath(container, title);
            else if (game === 'word') initWord(container, title);
        }

        function sendMove(data) {
            channel.send({ type: 'broadcast', event: 'game_move', payload: data });
        }

        function handleMove(data) {
            if (currGame === 'tictactoe') updateTTT(data);
            else if (currGame === 'rps') updateRPS(data);
            else if (currGame === 'dice') updateDice(data);
            else if (currGame === 'math') updateMath(data);
            else if (currGame === 'word') updateWord(data);
        }

        // --- GAME 1: TIC TAC TOE ---
        let tttBoard = [];
        let tttTurn = 'X';
        function initTTT(box, title) {
            title.innerText = "TIC TAC TOE";
            tttBoard = Array(9).fill(null);
            tttTurn = 'X';
            let html = '<div class="ttt-grid">';
            for(let i=0; i<9; i++) html += `<div id="c-${i}" class="ttt-cell" onclick="clkTTT(${i})"></div>`;
            html += '</div><p id="ttt-info">Turn: X</p>';
            box.innerHTML = html;
        }
        function clkTTT(i) {
            if(tttBoard[i] || document.getElementById('game-result').innerText) return;
            // Kirim move
            sendMove({ idx: i, p: tttTurn }); // Optimistic UI update di handleMove
            updateTTT({ idx: i, p: tttTurn }); // Update diri sendiri langsung
        }
        function updateTTT(d) {
            if(tttBoard[d.idx]) return; // Cegah double
            tttBoard[d.idx] = d.p;
            document.getElementById(`c-${d.idx}`).innerText = d.p;
            document.getElementById(`c-${d.idx}`).style.color = d.p === 'X' ? 'var(--neon-blue)' : 'var(--neon-pink)';
            
            // Cek Win
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            let winner = null;
            wins.forEach(w => {
                if(tttBoard[w[0]] && tttBoard[w[0]] === tttBoard[w[1]] && tttBoard[w[0]] === tttBoard[w[2]]) winner = tttBoard[w[0]];
            });

            if(winner) document.getElementById('game-result').innerText = `${winner} WINS!`;
            else if(!tttBoard.includes(null)) document.getElementById('game-result').innerText = "DRAW!";
            
            tttTurn = d.p === 'X' ? 'O' : 'X';
            document.getElementById('ttt-info').innerText = `Turn: ${tttTurn}`;
        }

        // --- GAME 2: ROCK PAPER SCISSOR ---
        function initRPS(box, title) {
            title.innerText = "ROCK PAPER SCISSOR";
            box.innerHTML = `
                <div style="display:flex; gap:10px;">
                    <button onclick="pickRPS('‚úä')" style="font-size:2rem; padding:10px;">‚úä</button>
                    <button onclick="pickRPS('üñêÔ∏è')" style="font-size:2rem; padding:10px;">üñêÔ∏è</button>
                    <button onclick="pickRPS('‚úåÔ∏è')" style="font-size:2rem; padding:10px;">‚úåÔ∏è</button>
                </div>
                <p id="rps-status">Pilih Tanganmu!</p>
            `;
        }
        let myRPS = null;
        function pickRPS(c) {
            myRPS = c;
            document.getElementById('rps-status').innerText = `Kamu pilih ${c}. Menunggu lawan...`;
            sendMove({ action: 'pick', id: myId }); // Beritahu lawan kita sudah milih (tanpa kasih tau apa)
        }
        function updateRPS(d) {
            if(d.action === 'pick' && d.id !== myId) {
                // Lawan sudah milih
                if(myRPS) {
                    // Kita juga sudah milih -> REVEAL
                    sendMove({ action: 'reveal', c: myRPS, id: myId });
                } else {
                    document.getElementById('game-result').innerText = "Lawan sudah siap! Giliranmu.";
                }
            } else if (d.action === 'reveal' && d.id !== myId) {
                // Lawan reveal, kita bandingkan
                let res = "SERI";
                let enemy = d.c;
                if((myRPS=='‚úä'&&enemy=='‚úåÔ∏è') || (myRPS=='üñêÔ∏è'&&enemy=='‚úä') || (myRPS=='‚úåÔ∏è'&&enemy=='üñêÔ∏è')) res = "MENANG!";
                else if(myRPS !== enemy) res = "KALAH!";
                document.getElementById('game-result').innerText = `Kamu: ${myRPS} vs Lawan: ${enemy} = ${res}`;
            }
        }

        // --- GAME 3: MATH DUEL ---
        function initMath(box, title) {
            title.innerText = "MATH DUEL";
            if(isHost) {
                let a = Math.floor(Math.random()*20), b = Math.floor(Math.random()*20);
                sendMove({ t: 'q', q: `${a} + ${b}`, a: a+b });
                // Host juga harus render diri sendiri
                renderMath(box, `${a} + ${b}`, a+b);
            } else {
                box.innerHTML = "<p>Menunggu Host...</p>";
            }
        }
        let mathAns = 0;
        function renderMath(box, q, a) {
            mathAns = a;
            box.innerHTML = `<h1 style="font-size:3rem">${q}</h1><input type="number" oninput="chkMath(this.value)">`;
            document.querySelector('input').focus();
        }
        function chkMath(v) {
            if(parseInt(v) === mathAns) {
                sendMove({ t: 'win', id: myId });
                document.getElementById('game-result').innerText = "KAMU MENANG!";
                document.querySelector('input').disabled = true;
            }
        }
        function updateMath(d) {
            if(d.t === 'q') renderMath(document.getElementById('game-container'), d.q, d.a);
            if(d.t === 'win') {
                document.getElementById('game-result').innerText = (d.id === myId) ? "KAMU MENANG!" : "LAWAN MENANG!";
                let inp = document.querySelector('input');
                if(inp) inp.disabled = true;
            }
        }

        // --- GAME 4: DICE ---
        function initDice(box, title) {
            title.innerText = "DICE BATTLE";
            box.innerHTML = `<h1 id="dice-disp" style="font-size:4rem">üé≤</h1><button onclick="roll()">ROLL</button>`;
        }
        function roll() {
            let r = Math.floor(Math.random()*6)+1;
            document.getElementById('dice-disp').innerText = r;
            sendMove({ r: r, id: myId });
            document.getElementById('game-result').innerText = `Kamu dapat ${r}`;
        }
        function updateDice(d) {
            if(d.id !== myId) {
                let curr = document.getElementById('game-result').innerText;
                document.getElementById('game-result').innerText = `${curr} | Lawan: ${d.r}`;
            }
        }

        // --- GAME 5: TYPING ---
        const words = ["JAVASCRIPT", "SUPABASE", "INTERNET", "PROGRAMMER", "CHAMPION"];
        function initWord(box, title) {
            title.innerText = "TYPING RACE";
            if(isHost) {
                let w = words[Math.floor(Math.random()*words.length)];
                sendMove({ t: 'q', w: w });
                renderWord(box, w);
            } else {
                box.innerHTML = "Wait...";
            }
        }
        let targetW = "";
        function renderWord(box, w) {
            targetW = w;
            box.innerHTML = `<h2 style="letter-spacing:5px; color:var(--neon-blue)">${w}</h2><input type="text" oninput="chkW(this.value)" style="text-transform:uppercase">`;
        }
        function chkW(v) {
            if(v.toUpperCase() === targetW) {
                sendMove({ t: 'win', id: myId });
                document.getElementById('game-result').innerText = "MENANG!";
                document.querySelector('input').disabled = true;
            }
        }
        function updateWord(d) {
            if(d.t === 'q') renderWord(document.getElementById('game-container'), d.w);
            if(d.t === 'win') {
                 document.getElementById('game-result').innerText = (d.id === myId) ? "MENANG!" : "KALAH!";
                 let inp = document.querySelector('input'); if(inp) inp.disabled = true;
            }
        }

    </script>
</body>
</html>
